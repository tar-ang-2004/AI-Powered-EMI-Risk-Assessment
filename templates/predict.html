{% extends "base.html" %}

{% block title %}EMI Prediction - EMI Risk Assessment Platform{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">EMI Risk Assessment</h1>
        <p class="text-xl text-gray-600">
            Enter customer details to get instant EMI eligibility prediction and risk assessment
        </p>
    </div>

    <!-- Prediction Form -->
    <div class="glassmorphism-card backdrop-blur-md bg-white/25 border border-white/20 rounded-2xl shadow-xl shadow-blue-100/25 p-8 mb-8">
        <!-- Form Header with Sample Data Button -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Customer Details</h2>
            <button type="button" 
                    onclick="fillSampleData('prediction')" 
                    class="glassmorphism-button backdrop-blur-md bg-gradient-to-r from-purple-600/80 to-pink-600/80 hover:from-purple-700/90 hover:to-pink-700/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 hover:shadow-lg flex items-center border border-white/30">
                <i class="fas fa-magic mr-2"></i>
                Fill Sample Data
            </button>
        </div>
        
        <form id="prediction-form">
            <!-- Personal Information -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-user text-primary-600 mr-3"></i>
                    Personal Information
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-2">Age *</label>
                        <input type="number" id="age" name="age" required min="18" max="80"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200 placeholder-gray-500">
                    </div>
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-2">Gender *</label>
                        <select id="gender" name="gender" required
                                class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div>
                        <label for="marital_status" class="block text-sm font-medium text-gray-700 mb-2">Marital Status *</label>
                        <select id="marital_status" name="marital_status" required
                                class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200">
                            <option value="">Select Status</option>
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                            <option value="Divorced">Divorced</option>
                        </select>
                    </div>
                    <div>
                        <label for="education" class="block text-sm font-medium text-gray-700 mb-2">Education *</label>
                        <select id="education" name="education" required
                                class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200">
                            <option value="">Select Education</option>
                            <option value="High_School">High School</option>
                            <option value="Undergraduate">Undergraduate</option>
                            <option value="Graduate">Graduate</option>
                            <option value="Post_Graduate">Post Graduate</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div>
                        <label for="family_size" class="block text-sm font-medium text-gray-700 mb-2">Family Size *</label>
                        <input type="number" id="family_size" name="family_size" required min="1" max="10"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200 placeholder-gray-500">
                    </div>
                    <div>
                        <label for="dependents" class="block text-sm font-medium text-gray-700 mb-2">Dependents *</label>
                        <input type="number" id="dependents" name="dependents" required min="0" max="10"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200 placeholder-gray-500">
                    </div>
                </div>
            </div>

            <!-- Employment Information -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-briefcase text-primary-600 mr-3"></i>
                    Employment Information
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="employment_type" class="block text-sm font-medium text-gray-700 mb-2">Employment Type *</label>
                        <select id="employment_type" name="employment_type" required
                                class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200">
                            <option value="">Select Type</option>
                            <option value="Government">Government</option>
                            <option value="Private">Private</option>
                            <option value="Self_Employed">Self Employed</option>
                            <option value="Contract">Contract</option>
                        </select>
                    </div>
                    <div>
                        <label for="company_type" class="block text-sm font-medium text-gray-700 mb-2">Company Type *</label>
                        <select id="company_type" name="company_type" required
                                class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200">
                            <option value="">Select Company Type</option>
                            <option value="MNC">MNC</option>
                            <option value="Startup">Startup</option>
                            <option value="SME">SME</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div>
                        <label for="years_of_employment" class="block text-sm font-medium text-gray-700 mb-2">Years of Employment *</label>
                        <input type="number" id="years_of_employment" name="years_of_employment" required min="0" max="50" step="0.1"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200">
                    </div>
                    <div>
                        <label for="monthly_salary" class="block text-sm font-medium text-gray-700 mb-2">Monthly Salary (₹) *</label>
                        <input type="number" id="monthly_salary" name="monthly_salary" required min="10000" max="10000000"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 50000">
                    </div>
                </div>
            </div>

            <!-- Financial Information -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-rupee-sign text-primary-600 mr-3"></i>
                    Financial Information
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="credit_score" class="block text-sm font-medium text-gray-700 mb-2">Credit Score *</label>
                        <input type="number" id="credit_score" name="credit_score" required min="300" max="850"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 750">
                    </div>
                    <div>
                        <label for="bank_balance" class="block text-sm font-medium text-gray-700 mb-2">Bank Balance (₹) *</label>
                        <input type="number" id="bank_balance" name="bank_balance" required min="0"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 100000">
                    </div>
                    <div>
                        <label for="emergency_fund" class="block text-sm font-medium text-gray-700 mb-2">Emergency Fund (₹) *</label>
                        <input type="number" id="emergency_fund" name="emergency_fund" required min="0"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 50000">
                    </div>
                    <div>
                        <label for="existing_loans" class="block text-sm font-medium text-gray-700 mb-2">Existing Loans *</label>
                        <select id="existing_loans" name="existing_loans" required
                                class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200">
                            <option value="">Select Option</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label for="current_emi_amount" class="block text-sm font-medium text-gray-700 mb-2">Current EMI Amount (₹) *</label>
                        <input type="number" id="current_emi_amount" name="current_emi_amount" required min="0"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 5000">
                    </div>
                </div>
            </div>

            <!-- Housing Information -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-home text-primary-600 mr-3"></i>
                    Housing & Expenses
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="house_type" class="block text-sm font-medium text-gray-700 mb-2">House Type *</label>
                        <select id="house_type" name="house_type" required
                                class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200">
                            <option value="">Select Type</option>
                            <option value="Owned">Owned</option>
                            <option value="Rented">Rented</option>
                            <option value="Family">Family</option>
                        </select>
                    </div>
                    <div>
                        <label for="monthly_rent" class="block text-sm font-medium text-gray-700 mb-2">Monthly Rent (₹) *</label>
                        <input type="number" id="monthly_rent" name="monthly_rent" required min="0"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 10000">
                    </div>
                    <div>
                        <label for="school_fees" class="block text-sm font-medium text-gray-700 mb-2">School Fees (₹) *</label>
                        <input type="number" id="school_fees" name="school_fees" required min="0"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 2000">
                    </div>
                    <div>
                        <label for="college_fees" class="block text-sm font-medium text-gray-700 mb-2">College Fees (₹) *</label>
                        <input type="number" id="college_fees" name="college_fees" required min="0"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 3000">
                    </div>
                    <div>
                        <label for="travel_expenses" class="block text-sm font-medium text-gray-700 mb-2">Travel Expenses (₹) *</label>
                        <input type="number" id="travel_expenses" name="travel_expenses" required min="0"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 1500">
                    </div>
                    <div>
                        <label for="groceries_utilities" class="block text-sm font-medium text-gray-700 mb-2">Groceries & Utilities (₹) *</label>
                        <input type="number" id="groceries_utilities" name="groceries_utilities" required min="0"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 8000">
                    </div>
                    <div>
                        <label for="other_monthly_expenses" class="block text-sm font-medium text-gray-700 mb-2">Other Expenses (₹) *</label>
                        <input type="number" id="other_monthly_expenses" name="other_monthly_expenses" required min="0"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 2000">
                    </div>
                </div>
            </div>

            <!-- Loan Request Information -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-hand-holding-usd text-primary-600 mr-3"></i>
                    Loan Request Details
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="emi_scenario" class="block text-sm font-medium text-gray-700 mb-2">EMI Scenario *</label>
                        <select id="emi_scenario" name="emi_scenario" required
                                class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200">
                            <option value="">Select Scenario</option>
                            <option value="New_Loan">New Loan</option>
                            <option value="Refinance">Refinance</option>
                            <option value="Top_Up">Top Up</option>
                        </select>
                    </div>
                    <div>
                        <label for="requested_amount" class="block text-sm font-medium text-gray-700 mb-2">Requested Amount (₹) *</label>
                        <input type="number" id="requested_amount" name="requested_amount" required min="50000"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 500000">
                    </div>
                    <div>
                        <label for="requested_tenure" class="block text-sm font-medium text-gray-700 mb-2">Requested Tenure (Months) *</label>
                        <input type="number" id="requested_tenure" name="requested_tenure" required min="12" max="360"
                               class="glassmorphism-input w-full px-4 py-3 backdrop-blur-md bg-white/20 border border-white/25 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-white/40 transition-all duration-200"
                               placeholder="e.g., 240">
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center">
                <button type="submit" id="predict-btn"
                        class="px-8 py-4 bg-primary-600 text-white font-semibold rounded-lg shadow-lg hover:bg-primary-700 transform hover:scale-105 transition-all duration-300 flex items-center">
                    <i class="fas fa-chart-line mr-3"></i>
                    Analyze Risk Assessment
                </button>
            </div>
        </form>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="hidden glassmorphism-card backdrop-blur-md bg-white/25 border border-white/20 rounded-2xl shadow-xl shadow-blue-100/25 p-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Risk Assessment Results</h2>
        
        <!-- Eligibility Result -->
        <div id="eligibility-result" class="mb-8 p-6 rounded-lg border-l-4">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-semibold mb-2" id="eligibility-title"></h3>
                    <p class="text-gray-600" id="eligibility-description"></p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="confidence-score"></div>
                    <div class="text-sm text-gray-500">Confidence</div>
                </div>
            </div>
        </div>

        <!-- EMI Details -->
        <div id="emi-details" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="glassmorphism-card backdrop-blur-md bg-white/25 border border-white/20 rounded-2xl shadow-xl shadow-blue-100/25 p-6 text-center">
                <i class="fas fa-rupee-sign text-3xl text-primary-600 mb-3"></i>
                <h4 class="text-lg font-semibold text-gray-900 mb-2">Maximum EMI</h4>
                <p class="text-2xl font-bold text-primary-600" id="max-emi-amount"></p>
            </div>
            <div class="glassmorphism-card backdrop-blur-md bg-white/25 border border-white/20 rounded-2xl shadow-xl shadow-blue-100/25 p-6 text-center">
                <i class="fas fa-percentage text-3xl text-success-600 mb-3"></i>
                <h4 class="text-lg font-semibold text-gray-900 mb-2">EMI to Income Ratio</h4>
                <p class="text-2xl font-bold text-success-600" id="emi-ratio"></p>
            </div>
            <div class="glassmorphism-card backdrop-blur-md bg-white/25 border border-white/20 rounded-2xl shadow-xl shadow-blue-100/25 p-6 text-center">
                <i class="fas fa-wallet text-3xl text-warning-600 mb-3"></i>
                <h4 class="text-lg font-semibold text-gray-900 mb-2">Disposable Income</h4>
                <p class="text-2xl font-bold text-warning-600" id="disposable-income"></p>
            </div>
        </div>

        <!-- Risk Level -->
        <div id="risk-level-section" class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-gray-900">Risk Assessment</h3>
                <span id="risk-badge" class="px-4 py-2 rounded-full text-sm font-semibold"></span>
            </div>
            <div class="bg-gray-200 rounded-full h-4 mb-4">
                <div id="risk-progress" class="h-4 rounded-full transition-all duration-500"></div>
            </div>
            <p id="risk-description" class="text-gray-600"></p>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <button id="save-result-btn" 
                    class="px-6 py-3 bg-success-600 text-white font-semibold rounded-lg hover:bg-success-700 transition-all duration-300 flex items-center justify-center">
                <i class="fas fa-save mr-2"></i>
                Save Result
            </button>
            <button onclick="window.print()" 
                    class="px-6 py-3 bg-secondary-600 text-white font-semibold rounded-lg hover:bg-secondary-700 transition-all duration-300 flex items-center justify-center">
                <i class="fas fa-print mr-2"></i>
                Print Report
            </button>
            <button onclick="location.reload()" 
                    class="px-6 py-3 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 transition-all duration-300 flex items-center justify-center">
                <i class="fas fa-redo mr-2"></i>
                New Assessment
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentFormData = {};
    let currentResults = {};

    document.getElementById('prediction-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate form
        if (!validateForm('prediction-form')) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }
        
        // Collect form data
        const formData = new FormData(this);
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        currentFormData = data;
        
        // Show loading
        showLoading();
        document.getElementById('predict-btn').disabled = true;
        document.getElementById('predict-btn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        
        try {
            // Get comprehensive prediction
            const result = await makeAPIRequest('/api/predict/comprehensive', data, 'POST');
            currentResults = result;
            
            // Display results
            displayResults(result);
            
            // Show results section
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
            
            showNotification('Risk assessment completed successfully!', 'success');
            
        } catch (error) {
            showNotification(`Error: ${error.message}`, 'error');
        } finally {
            hideLoading();
            document.getElementById('predict-btn').disabled = false;
            document.getElementById('predict-btn').innerHTML = '<i class="fas fa-chart-line mr-2"></i>Analyze Risk Assessment';
        }
    });

    function displayResults(result) {
        const eligibilitySection = document.getElementById('eligibility-result');
        const eligibilityTitle = document.getElementById('eligibility-title');
        const eligibilityDescription = document.getElementById('eligibility-description');
        const confidenceScore = document.getElementById('confidence-score');
        
        // Display eligibility
        if (result.eligibility.eligibility === 'Eligible') {
            eligibilitySection.className = 'mb-8 p-6 rounded-lg border-l-4 border-success-500 bg-success-50';
            eligibilityTitle.textContent = '✅ EMI Eligible';
            eligibilityTitle.className = 'text-xl font-semibold mb-2 text-success-700';
            eligibilityDescription.textContent = 'Congratulations! The customer is eligible for EMI.';
            
            // Show EMI details
            document.getElementById('emi-details').classList.remove('hidden');
            
            if (result.emi_prediction) {
                document.getElementById('max-emi-amount').textContent = formatCurrency(result.emi_prediction.max_monthly_emi);
                document.getElementById('emi-ratio').textContent = result.emi_prediction.emi_to_income_ratio.toFixed(2) + '%';
                document.getElementById('disposable-income').textContent = formatCurrency(result.emi_prediction.monthly_disposable_income);
            }
        } else {
            eligibilitySection.className = 'mb-8 p-6 rounded-lg border-l-4 border-danger-500 bg-danger-50';
            eligibilityTitle.textContent = '❌ Not Eligible';
            eligibilityTitle.className = 'text-xl font-semibold mb-2 text-danger-700';
            eligibilityDescription.textContent = 'The customer does not meet EMI eligibility criteria.';
            
            // Hide EMI details
            document.getElementById('emi-details').classList.add('hidden');
        }
        
        confidenceScore.textContent = result.eligibility.confidence.toFixed(1) + '%';
        
        // Display risk level
        displayRiskLevel(result.risk_level);
    }

    function displayRiskLevel(riskLevel) {
        const riskBadge = document.getElementById('risk-badge');
        const riskProgress = document.getElementById('risk-progress');
        const riskDescription = document.getElementById('risk-description');
        
        let riskPercentage, badgeClass, progressClass, description;
        
        switch(riskLevel) {
            case 'Low':
                riskPercentage = 25;
                badgeClass = 'bg-success-100 text-success-800';
                progressClass = 'bg-success-500';
                description = 'Low risk profile. Customer shows strong financial stability and good repayment capacity.';
                break;
            case 'Moderate':
                riskPercentage = 60;
                badgeClass = 'bg-warning-100 text-warning-800';
                progressClass = 'bg-warning-500';
                description = 'Moderate risk profile. Customer meets basic criteria but should be monitored carefully.';
                break;
            case 'High':
                riskPercentage = 90;
                badgeClass = 'bg-danger-100 text-danger-800';
                progressClass = 'bg-danger-500';
                description = 'High risk profile. Customer may face challenges in loan repayment. Consider additional security.';
                break;
            default:
                riskPercentage = 50;
                badgeClass = 'bg-gray-100 text-gray-800';
                progressClass = 'bg-gray-500';
                description = 'Risk assessment could not be determined.';
        }
        
        riskBadge.textContent = riskLevel + ' Risk';
        riskBadge.className = `px-4 py-2 rounded-full text-sm font-semibold ${badgeClass}`;
        
        riskProgress.style.width = riskPercentage + '%';
        riskProgress.className = `h-4 rounded-full transition-all duration-500 ${progressClass}`;
        
        riskDescription.textContent = description;
    }

    // Save result functionality
    document.getElementById('save-result-btn').addEventListener('click', async function() {
        if (!currentFormData || !currentResults) {
            showNotification('No data to save', 'error');
            return;
        }
        
        const saveData = {
            ...currentFormData,
            predicted_eligibility: currentResults.eligibility.eligibility,
            predicted_emi_amount: currentResults.emi_prediction ? currentResults.emi_prediction.max_monthly_emi : null
        };
        
        try {
            showLoading();
            const result = await makeAPIRequest('/api/save_record', saveData, 'POST');
            showNotification(`Record saved successfully with ID: ${result.record_id}`, 'success');
        } catch (error) {
            showNotification(`Error saving record: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    });

    // Auto-calculate total monthly expenses
    const expenseFields = ['monthly_rent', 'school_fees', 'college_fees', 'travel_expenses', 'groceries_utilities', 'other_monthly_expenses'];
    
    expenseFields.forEach(field => {
        document.getElementById(field).addEventListener('input', calculateTotalExpenses);
    });
    
    function calculateTotalExpenses() {
        let total = 0;
        expenseFields.forEach(field => {
            const value = parseFloat(document.getElementById(field).value) || 0;
            total += value;
        });
        
        // You can display this total somewhere if needed
        // For now, we'll just validate it doesn't exceed salary
        const salary = parseFloat(document.getElementById('monthly_salary').value) || 0;
        if (total > salary * 0.8) {
            showNotification('Warning: Total expenses are very high compared to salary', 'warning');
        }
    }

    // Credit score validation
    document.getElementById('credit_score').addEventListener('input', function() {
        const score = parseInt(this.value);
        const scoreField = this;
        
        if (score < 300 || score > 850) {
            scoreField.classList.add('border-danger-500');
            showNotification('Credit score should be between 300 and 850', 'warning');
        } else {
            scoreField.classList.remove('border-danger-500');
            
            // Show credit score category
            let category = '';
            if (score < 600) category = 'Poor';
            else if (score < 700) category = 'Fair';
            else if (score < 750) category = 'Good';
            else category = 'Excellent';
            
            // You can show this category somewhere near the field
        }
    });

    // EMI calculator helper
    function calculateEMI(principal, rate, tenure) {
        const monthlyRate = rate / 12 / 100;
        const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, tenure) / (Math.pow(1 + monthlyRate, tenure) - 1);
        return emi;
    }

    // Form field animations
    document.querySelectorAll('input, select').forEach(field => {
        field.addEventListener('focus', function() {
            this.parentElement.classList.add('transform', 'scale-105');
        });
        
        field.addEventListener('blur', function() {
            this.parentElement.classList.remove('transform', 'scale-105');
        });
    });
</script>
<script src="{{ url_for('static', filename='js/predict_enhanced.js') }}"></script>
{% endblock %}
