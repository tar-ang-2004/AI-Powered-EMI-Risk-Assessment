<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Integration Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .test-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">
            ğŸ§ª Enhanced Integration Test Suite
        </h1>
        
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-semibold mb-4">ğŸ”§ System Tests</h2>
                <div id="systemTests"></div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-semibold mb-4">ğŸš€ API Endpoint Tests</h2>
                <div id="apiTests"></div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-semibold mb-4">ğŸ“± Frontend Integration Tests</h2>
                <div id="frontendTests"></div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-semibold mb-4">âš¡ Performance Tests</h2>
                <div id="performanceTests"></div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4">ğŸ“Š Test Summary</h2>
                <div id="testSummary"></div>
            </div>
        </div>
    </div>

    <script>
        class IntegrationTester {
            constructor() {
                this.results = {
                    passed: 0,
                    failed: 0,
                    total: 0
                };
                this.init();
            }

            async init() {
                await this.runSystemTests();
                await this.runAPITests();
                await this.runFrontendTests();
                await this.runPerformanceTests();
                this.displaySummary();
            }

            addTestResult(container, testName, success, message = '') {
                const div = document.createElement('div');
                div.className = `test-result ${success ? 'test-success' : 'test-error'}`;
                div.innerHTML = `
                    <strong>${success ? 'âœ…' : 'âŒ'} ${testName}</strong>
                    ${message ? `<br><small>${message}</small>` : ''}
                `;
                document.getElementById(container).appendChild(div);
                
                this.results.total++;
                if (success) this.results.passed++;
                else this.results.failed++;
            }

            addPendingTest(container, testName, message = '') {
                const div = document.createElement('div');
                div.className = 'test-result test-pending';
                div.innerHTML = `
                    <strong>â³ ${testName}</strong>
                    ${message ? `<br><small>${message}</small>` : ''}
                `;
                document.getElementById(container).appendChild(div);
            }

            async runSystemTests() {
                this.addPendingTest('systemTests', 'Checking Flask Server', 'Testing server connectivity...');
                
                try {
                    const response = await fetch('/');
                    this.addTestResult('systemTests', 'Flask Server Status', response.ok, 
                        `Server responded with status: ${response.status}`);
                } catch (error) {
                    this.addTestResult('systemTests', 'Flask Server Status', false, 
                        `Server connection failed: ${error.message}`);
                }

                // Test static file serving
                try {
                    const response = await fetch('/static/js/main_enhanced.js');
                    this.addTestResult('systemTests', 'Enhanced JavaScript Loading', response.ok,
                        `Enhanced JS file loaded successfully`);
                } catch (error) {
                    this.addTestResult('systemTests', 'Enhanced JavaScript Loading', false,
                        `Failed to load enhanced JS: ${error.message}`);
                }

                // Test CSS loading
                try {
                    const response = await fetch('/static/css/custom.css');
                    this.addTestResult('systemTests', 'Custom CSS Loading', response.ok,
                        `Custom CSS loaded successfully`);
                } catch (error) {
                    this.addTestResult('systemTests', 'Custom CSS Loading', false,
                        `Failed to load custom CSS: ${error.message}`);
                }
            }

            async runAPITests() {
                // Test EMI prediction API
                const emiTestData = {
                    age: 30,
                    gender: "Male",
                    marital_status: "Married",
                    education: "Graduate",
                    family_size: 3,
                    dependents: 1,
                    employment_type: "Private",
                    company_type: "MNC",
                    years_of_employment: 5,
                    monthly_salary: 75000,
                    credit_score: 750,
                    bank_balance: 200000,
                    emergency_fund: 100000,
                    house_type: "Rented",
                    monthly_rent: 25000,
                    school_fees: 5000,
                    college_fees: 0,
                    travel_expenses: 5000,
                    groceries_utilities: 15000,
                    other_monthly_expenses: 5000,
                    existing_loans: "No",
                    current_emi_amount: 0,
                    emi_scenario: "New_Loan",
                    requested_amount: 800000,
                    requested_tenure: 240
                };

                try {
                    const response = await fetch('/api/predict_emi_amount', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(emiTestData)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.addTestResult('apiTests', 'EMI Prediction API', true,
                            `Predicted EMI: â‚¹${data.formatted_amount}, Risk: ${data.risk_level}`);
                    } else {
                        this.addTestResult('apiTests', 'EMI Prediction API', false,
                            `API returned status: ${response.status}`);
                    }
                } catch (error) {
                    this.addTestResult('apiTests', 'EMI Prediction API', false,
                        `API call failed: ${error.message}`);
                }

                // Test eligibility prediction API
                const eligibilityTestData = {
                    ...emiTestData,
                    property_value: 1200000,
                    down_payment: 400000,
                    property_type: "Apartment",
                    property_location: "Metro"
                };

                try {
                    const response = await fetch('/api/predict_eligibility', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(eligibilityTestData)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.addTestResult('apiTests', 'Eligibility Prediction API', true,
                            `Status: ${data.eligibility_status}, Confidence: ${(data.confidence * 100).toFixed(1)}%`);
                    } else {
                        this.addTestResult('apiTests', 'Eligibility Prediction API', false,
                            `API returned status: ${response.status}`);
                    }
                } catch (error) {
                    this.addTestResult('apiTests', 'Eligibility Prediction API', false,
                        `API call failed: ${error.message}`);
                }

                // Test comprehensive prediction API
                try {
                    const response = await fetch('/api/predict/comprehensive', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(eligibilityTestData)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.addTestResult('apiTests', 'Comprehensive Prediction API', true,
                            `Complete analysis returned with ${Object.keys(data).length} metrics`);
                    } else {
                        this.addTestResult('apiTests', 'Comprehensive Prediction API', false,
                            `API returned status: ${response.status}`);
                    }
                } catch (error) {
                    this.addTestResult('apiTests', 'Comprehensive Prediction API', false,
                        `API call failed: ${error.message}`);
                }
            }

            async runFrontendTests() {
                // Test page navigation
                const pages = [
                    { name: 'Calculator Page', url: '/calculate' },
                    { name: 'Prediction Page', url: '/predict' },
                    { name: 'Lenders Page', url: '/lenders' },
                    { name: 'Prepayment Page', url: '/prepayment' },
                    { name: 'Dashboard Page', url: '/dashboard' },
                    { name: 'What-If Page', url: '/whatif' }
                ];

                for (const page of pages) {
                    try {
                        const response = await fetch(page.url);
                        this.addTestResult('frontendTests', page.name, response.ok,
                            `Page loads successfully (${response.status})`);
                    } catch (error) {
                        this.addTestResult('frontendTests', page.name, false,
                            `Failed to load: ${error.message}`);
                    }
                }

                // Test JavaScript functionality
                const jsTests = [
                    () => typeof window.EMICalculator !== 'undefined',
                    () => typeof window.MLPredictor !== 'undefined',
                    () => typeof window.LenderMatcher !== 'undefined',
                    () => typeof window.PrepaymentAnalyzer !== 'undefined'
                ];

                const jsTestNames = [
                    'EMI Calculator JS',
                    'ML Predictor JS',
                    'Lender Matcher JS',
                    'Prepayment Analyzer JS'
                ];

                jsTests.forEach((test, index) => {
                    try {
                        const result = test();
                        this.addTestResult('frontendTests', jsTestNames[index], result,
                            result ? 'JavaScript module loaded successfully' : 'Module not found');
                    } catch (error) {
                        this.addTestResult('frontendTests', jsTestNames[index], false,
                            `Error testing module: ${error.message}`);
                    }
                });
            }

            async runPerformanceTests() {
                // Test API response times
                const startTime = performance.now();
                
                try {
                    await fetch('/');
                    const endTime = performance.now();
                    const responseTime = endTime - startTime;
                    
                    this.addTestResult('performanceTests', 'Page Load Performance', responseTime < 1000,
                        `Home page loaded in ${responseTime.toFixed(2)}ms`);
                } catch (error) {
                    this.addTestResult('performanceTests', 'Page Load Performance', false,
                        `Performance test failed: ${error.message}`);
                }

                // Test API performance
                const apiStartTime = performance.now();
                try {
                    await fetch('/api/predict_emi_amount', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            age: 30, gender: "Male", monthly_salary: 50000,
                            requested_amount: 500000, requested_tenure: 240
                        })
                    });
                    const apiEndTime = performance.now();
                    const apiResponseTime = apiEndTime - apiStartTime;
                    
                    this.addTestResult('performanceTests', 'API Response Performance', apiResponseTime < 2000,
                        `API responded in ${apiResponseTime.toFixed(2)}ms`);
                } catch (error) {
                    this.addTestResult('performanceTests', 'API Response Performance', false,
                        `API performance test failed: ${error.message}`);
                }

                // Test memory usage (basic check)
                if (performance.memory) {
                    const memoryUsage = performance.memory.usedJSHeapSize / 1024 / 1024;
                    this.addTestResult('performanceTests', 'Memory Usage', memoryUsage < 50,
                        `JavaScript heap size: ${memoryUsage.toFixed(2)} MB`);
                } else {
                    this.addTestResult('performanceTests', 'Memory Usage', true,
                        'Memory monitoring not available in this browser');
                }
            }

            displaySummary() {
                const summaryContainer = document.getElementById('testSummary');
                const passRate = (this.results.passed / this.results.total * 100).toFixed(1);
                
                summaryContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-green-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-800">${this.results.passed}</div>
                            <div class="text-green-600">Tests Passed</div>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-800">${this.results.failed}</div>
                            <div class="text-red-600">Tests Failed</div>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-800">${passRate}%</div>
                            <div class="text-blue-600">Pass Rate</div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-semibold ${this.results.failed === 0 ? 'text-green-600' : 'text-orange-600'}">
                            ${this.results.failed === 0 ? 'ğŸ‰ All tests passed! Your enhanced integration is working perfectly.' : 
                              'âš ï¸ Some tests failed. Please review the results above for details.'}
                        </div>
                    </div>
                `;
            }
        }

        // Start the tests when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new IntegrationTester();
        });
    </script>
</body>
</html>